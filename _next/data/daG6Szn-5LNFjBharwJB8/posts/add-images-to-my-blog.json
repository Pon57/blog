{"pageProps":{"content":"<p>少しずつ弄ってるブログですが、この度画像を貼れるようにしました。</p>\n<p><a href=\"https://unsplash.com/photos/vpOeXr5wmR4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><img src=\"./static/james-harrison-vpOeXr5wmR4-unsplash.jpg\" alt=\"サンプル画像\"></a><br>\nｼﾞｬｰﾝ</p>\n<p>その時少しハマったので、ログを残しておきます。</p>\n<h2 id=\"使おうとしたもの\">使おうとしたもの</h2>\n<p><a href=\"https://github.com/remarkjs/remark-embed-images\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">remarkjs/remark-embed-images</a></p>\n<h2 id=\"やったこと\">やったこと</h2>\n<p><a href=\"https://github.com/Pon57/blog/commit/a74e1a337368daa3b692f78a9ae92f9b90b8881e\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/Pon57/blog/commit/a74e1a337368daa3b692f78a9ae92f9b90b8881e</a></p>\n<h2 id=\"引っかかったところ\">引っかかったところ</h2>\n<p><code>gray-matter</code> でメタデータを解析したのち、コンテンツの文字列を抜き出して使っていた。</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-keyword\">const</span> post = <span class=\"hljs-variable hljs-constant\">ALL_POSTS</span>.<span class=\"hljs-title hljs-function\">find</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">post</span> =></span> slug === post.<span class=\"hljs-property\">slug</span>) <span class=\"hljs-keyword\">as</span> <span class=\"hljs-title hljs-class\">Post</span>\n\n<span class=\"hljs-keyword\">const</span> processedContent = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title hljs-function\">unified</span>()\n    .<span class=\"hljs-title hljs-function\">use</span>(remarkParse)\n    .<span class=\"hljs-title hljs-function\">use</span>(remarkEmoji)\n    .<span class=\"hljs-title hljs-function\">use</span>(remarkBreaks)\n    .<span class=\"hljs-title hljs-function\">use</span>(remarkExternalLinks)\n    .<span class=\"hljs-title hljs-function\">use</span>(remark2rehype)\n    .<span class=\"hljs-title hljs-function\">use</span>(rehypeHighlight)\n    .<span class=\"hljs-title hljs-function\">use</span>(rehypeSlug)\n    .<span class=\"hljs-title hljs-function\">use</span>(rehypeStringify)\n    .<span class=\"hljs-title hljs-function\">process</span>(post.<span class=\"hljs-property\">content</span>)\n</code></pre>\n<p>これにそのまま <code>.use(remarkEmbedImages)</code> を忍び込ませ、ブログ本文に画像を入れてみた。<br>\nパスは <code>/posts/[slug]/hoge.png</code> という感じ。マークダウンファイルのパスはその当時は <code>/posts/[slug].md</code></p>\n<p>だけどどうもうまくいかなかったみたい。</p>\n<blockquote>\n<p>TypeError [ERR_INVALID_ARG_TYPE]: The \"path\" argument must be of type string. Received type undefined</p>\n</blockquote>\n<p>試しに絶対パスを入れたけど、画像の変換が行われず、固定文字列が入っちゃった。<br>\nプロジェクトルートから考えた相対パスを入れれば問題なく動いたけど、マークダウンファイルとの相対的な位置が合わず、プレビューもできないし嫌だな〜ということでボツ。</p>\n<h2 id=\"解決のためにやったこと\">解決のためにやったこと</h2>\n<p>出ている場所は <code>remarkEmbedImages</code> で間違いないが、なんのこっちゃという感じ。</p>\n<p>エラーが示していた場所はここ。<br>\n<a href=\"https://github.com/remarkjs/remark-embed-images/blob/main/index.js#L27\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/remarkjs/remark-embed-images/blob/main/index.js#L27</a></p>\n<p>入れている <code>path</code> が関係あるのかと思いきや、<code>path</code> の引数が <code>undefined</code> の場合もこういうエラーが出るらしい。（※追記：エラー文に書いてあるじゃん！）<br>\nVSCode で特に何もせず使えたデバッガーを利用して変数の中身を見てみると、どうやら <code>file.dirname</code> が原因だろうというところまでわかった。</p>\n<p>じゃあ <code>file</code> はなんなの？となるけど、コードを見てもいまいち分からず・・・</p>\n<p>なんか検索しているうちに再実装しているリポジトリを見つけた。<br>\n<a href=\"https://github.com/ahlec/jyosuushi/blob/0990e7c75c2df7c704acb9bcaca23bf999b3d181/scripts/markdown/parsing/embeded-images.ts\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/ahlec/jyosuushi/blob/0990e7c75c2df7c704acb9bcaca23bf999b3d181/scripts/markdown/parsing/embeded-images.ts</a></p>\n<p>そんなこんなしているうちに <code>file.dirname</code> に <code>posts</code> という固定文字列を入れてみた。動いた！<br>\nこの時世界が動き出した。</p>\n<p>なんでか覚えてないけど <code>.process()</code> には <code>vfile</code> を入れることができるということを知り、<code>vfile</code> は <code>dirname</code> や <code>path</code>、<code>cwd</code> があり、なんかみたことのあるな〜という感じ。<br>\n<a href=\"https://github.com/vfile/vfile\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/vfile/vfile</a></p>\n<p>そうか、<code>remark-embed-images</code> の <code>file</code> は <code>vfile</code> のことだったのか・・・となった（どうして <code>vfile</code> なのかはまだ分かってない）</p>\n<pre><code class=\"hljs language-diff\">const post = ALL_POSTS.find(post => slug <span class=\"hljs-comment\">=== post.slug) as Post</span>\n<span class=\"hljs-addition\">+ const file = toVFile({ value: post.content, path: process.cwd(), dirname: 'posts' })</span>\n\nconst processedContent = await unified()\n    .use(remarkParse)\n...\n    .use(rehypeStringify)\n<span class=\"hljs-deletion\">-   .process(post)</span>\n<span class=\"hljs-addition\">+   .process(file)</span>\n</code></pre>\n<p>としたら無事動いた 🎉</p>\n<h2 id=\"おわり\">おわり</h2>\n<p>なんで動いたのかとかあんまりよく分かっていないけど、文字列を <code>.process()</code> に入れるとファイルの中身だけはあるけど実体は無いみたいな扱いをされて、その結果 <code>dirname</code> が <code>undefined</code> になっていたとかそんな感じかなぁって思ってる。<br>\nそのうち気が向いたら追ってみると思う。</p>\n<p>とりあえず動くようになったのでよかった 😚</p>","slug":"add-images-to-my-blog","title":"ブログに画像を貼れるようにした","published":"2021-10-14","publishedIndex":1,"tags":["TypeScript","Next.js","Blog"],"fileName":"add-images-to-my-blog","staticFiles":["james-harrison-vpOeXr5wmR4-unsplash.jpg"]},"__N_SSG":true}