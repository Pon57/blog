<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><meta name="og:title" content="ブログに画像を貼れるようにした - ぽんブログ" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><title data-next-head="">ブログに画像を貼れるようにした - ぽんブログ</title><link rel="preload" href="/_next/static/css/28388b2201b96dd5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/28388b2201b96dd5.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e1d67faba6163aa1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e1d67faba6163aa1.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-59041051e025bed2.js" defer=""></script><script src="/_next/static/chunks/framework-384d27dd06c6faf3.js" defer=""></script><script src="/_next/static/chunks/main-4550fab03f83accb.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4fa09b1b2f71f6f3.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-594c9fb52fd3e062.js" defer=""></script><script src="/_next/static/6lyUpe6-GWfQPga3jDf8b/_buildManifest.js" defer=""></script><script src="/_next/static/6lyUpe6-GWfQPga3jDf8b/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="_app_site__wQ_HZ"><header class="_app_heading__uRQQR"><a class="_app_brand__aiSQf" href="/">ぽんブログ</a></header><div class="_app_content__mHXSR"><div class="_slug__published___nJg1">2021-10-14</div><h1 class="_slug__title__xQmM2">ブログに画像を貼れるようにした</h1><p class="_slug__tags__ZhcyH"><span class="_slug__tag__hrYB6">TypeScript</span><span class="_slug__tag__hrYB6">Next.js</span><span class="_slug__tag__hrYB6">Blog</span></p><div class="_slug__content__C7UY7"><p>※追記：その後実装を変えました <a href="/posts/add-images-to-my-blog2">ブログに画像を貼れるようにした〜その後〜</a></p>
<p>少しずつ弄ってるブログですが、この度画像を貼れるようにしました。</p>
<p><a href="https://unsplash.com/photos/vpOeXr5wmR4" rel="nofollow"><img src="./static/james-harrison-vpOeXr5wmR4-unsplash.jpg" alt="サンプル画像"></a><br>
ｼﾞｬｰﾝ</p>
<p>その時少しハマったので、ログを残しておきます。</p>
<h2 id="使おうとしたもの">使おうとしたもの</h2>
<p><a href="https://github.com/remarkjs/remark-embed-images" rel="nofollow">remarkjs/remark-embed-images</a></p>
<h2 id="やったこと">やったこと</h2>
<p><a href="https://github.com/Pon57/blog/commit/a74e1a337368daa3b692f78a9ae92f9b90b8881e" rel="nofollow">https://github.com/Pon57/blog/commit/a74e1a337368daa3b692f78a9ae92f9b90b8881e</a></p>
<h2 id="引っかかったところ">引っかかったところ</h2>
<p><code>gray-matter</code> でメタデータを解析したのち、コンテンツの文字列を抜き出して使っていた。</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> post = <span class="hljs-variable constant_">ALL_POSTS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">post</span> =></span> slug === post.<span class="hljs-property">slug</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Post</span>

<span class="hljs-keyword">const</span> processedContent = <span class="hljs-keyword">await</span> <span class="hljs-title function_">unified</span>()
    .<span class="hljs-title function_">use</span>(remarkParse)
    .<span class="hljs-title function_">use</span>(remarkEmoji)
    .<span class="hljs-title function_">use</span>(remarkBreaks)
    .<span class="hljs-title function_">use</span>(remarkExternalLinks)
    .<span class="hljs-title function_">use</span>(remark2rehype)
    .<span class="hljs-title function_">use</span>(rehypeHighlight)
    .<span class="hljs-title function_">use</span>(rehypeSlug)
    .<span class="hljs-title function_">use</span>(rehypeStringify)
    .<span class="hljs-title function_">process</span>(post.<span class="hljs-property">content</span>)
</code></pre>
<p>これにそのまま <code>.use(remarkEmbedImages)</code> を忍び込ませ、ブログ本文に画像を入れてみた。<br>
パスは <code>/posts/[slug]/hoge.png</code> という感じ。マークダウンファイルのパスはその当時は <code>/posts/[slug].md</code></p>
<p>だけどどうもうまくいかなかったみたい。</p>
<blockquote>
<p>TypeError [ERR_INVALID_ARG_TYPE]: The "path" argument must be of type string. Received type undefined</p>
</blockquote>
<p>試しに絶対パスを入れたけど、画像の変換が行われず、固定文字列が入っちゃった。<br>
プロジェクトルートから考えた相対パスを入れれば問題なく動いたけど、マークダウンファイルとの相対的な位置が合わず、プレビューもできないし嫌だな〜ということでボツ。</p>
<h2 id="解決のためにやったこと">解決のためにやったこと</h2>
<p>出ている場所は <code>remarkEmbedImages</code> で間違いないが、なんのこっちゃという感じ。</p>
<p>エラーが示していた場所はここ。<br>
<a href="https://github.com/remarkjs/remark-embed-images/blob/main/index.js#L27" rel="nofollow">https://github.com/remarkjs/remark-embed-images/blob/main/index.js#L27</a></p>
<p>入れている <code>path</code> が関係あるのかと思いきや、<code>path</code> の引数が <code>undefined</code> の場合もこういうエラーが出るらしい。（※追記：エラー文に書いてあるじゃん！）<br>
VSCode で特に何もせず使えたデバッガーを利用して変数の中身を見てみると、どうやら <code>file.dirname</code> が原因だろうというところまでわかった。</p>
<p>じゃあ <code>file</code> はなんなの？となるけど、コードを見てもいまいち分からず・・・</p>
<p>なんか検索しているうちに再実装しているリポジトリを見つけた。<br>
<a href="https://github.com/ahlec/jyosuushi/blob/0990e7c75c2df7c704acb9bcaca23bf999b3d181/scripts/markdown/parsing/embeded-images.ts" rel="nofollow">https://github.com/ahlec/jyosuushi/blob/0990e7c75c2df7c704acb9bcaca23bf999b3d181/scripts/markdown/parsing/embeded-images.ts</a></p>
<p>そんなこんなしているうちに <code>file.dirname</code> に <code>posts</code> という固定文字列を入れてみた。動いた！<br>
この時世界が動き出した。</p>
<p>なんでか覚えてないけど <code>.process()</code> には <code>vfile</code> を入れることができるということを知り、<code>vfile</code> は <code>dirname</code> や <code>path</code>、<code>cwd</code> があり、なんかみたことのあるな〜という感じ。<br>
<a href="https://github.com/vfile/vfile" rel="nofollow">https://github.com/vfile/vfile</a></p>
<p>そうか、<code>remark-embed-images</code> の <code>file</code> は <code>vfile</code> のことだったのか・・・となった（どうして <code>vfile</code> なのかはまだ分かってない）</p>
<pre><code class="hljs language-diff">const post = ALL_POSTS.find(post => slug <span class="hljs-comment">=== post.slug) as Post</span>
<span class="hljs-addition">+ const file = toVFile({ value: post.content, path: process.cwd(), dirname: 'posts' })</span>

const processedContent = await unified()
    .use(remarkParse)
...
    .use(rehypeStringify)
<span class="hljs-deletion">-   .process(post)</span>
<span class="hljs-addition">+   .process(file)</span>
</code></pre>
<p>としたら無事動いた 🎉</p>
<h2 id="おわり">おわり</h2>
<p>なんで動いたのかとかあんまりよく分かっていないけど、文字列を <code>.process()</code> に入れるとファイルの中身だけはあるけど実体は無いみたいな扱いをされて、その結果 <code>dirname</code> が <code>undefined</code> になっていたとかそんな感じかなぁって思ってる。<br>
そのうち気が向いたら追ってみると思う。</p>
<p>とりあえず動くようになったのでよかった 😚</p></div></div><footer class="_app_footer___uvS6">© 2021<!-- --> <a target="_blank" rel="noreferrer" href="https://twitter.com/pon_dev">Pon</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"content":"\u003cp\u003e※追記：その後実装を変えました \u003ca href=\"/posts/add-images-to-my-blog2\"\u003eブログに画像を貼れるようにした〜その後〜\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e少しずつ弄ってるブログですが、この度画像を貼れるようにしました。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://unsplash.com/photos/vpOeXr5wmR4\" rel=\"nofollow\"\u003e\u003cimg src=\"./static/james-harrison-vpOeXr5wmR4-unsplash.jpg\" alt=\"サンプル画像\"\u003e\u003c/a\u003e\u003cbr\u003e\nｼﾞｬｰﾝ\u003c/p\u003e\n\u003cp\u003eその時少しハマったので、ログを残しておきます。\u003c/p\u003e\n\u003ch2 id=\"使おうとしたもの\"\u003e使おうとしたもの\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/remarkjs/remark-embed-images\" rel=\"nofollow\"\u003eremarkjs/remark-embed-images\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"やったこと\"\u003eやったこと\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Pon57/blog/commit/a74e1a337368daa3b692f78a9ae92f9b90b8881e\" rel=\"nofollow\"\u003ehttps://github.com/Pon57/blog/commit/a74e1a337368daa3b692f78a9ae92f9b90b8881e\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"引っかかったところ\"\u003e引っかかったところ\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003egray-matter\u003c/code\u003e でメタデータを解析したのち、コンテンツの文字列を抜き出して使っていた。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e post = \u003cspan class=\"hljs-variable constant_\"\u003eALL_POSTS\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efind\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003epost\u003c/span\u003e =\u003e\u003c/span\u003e slug === post.\u003cspan class=\"hljs-property\"\u003eslug\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePost\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e processedContent = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eunified\u003c/span\u003e()\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(remarkParse)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(remarkEmoji)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(remarkBreaks)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(remarkExternalLinks)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(remark2rehype)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(rehypeHighlight)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(rehypeSlug)\n    .\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(rehypeStringify)\n    .\u003cspan class=\"hljs-title function_\"\u003eprocess\u003c/span\u003e(post.\u003cspan class=\"hljs-property\"\u003econtent\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこれにそのまま \u003ccode\u003e.use(remarkEmbedImages)\u003c/code\u003e を忍び込ませ、ブログ本文に画像を入れてみた。\u003cbr\u003e\nパスは \u003ccode\u003e/posts/[slug]/hoge.png\u003c/code\u003e という感じ。マークダウンファイルのパスはその当時は \u003ccode\u003e/posts/[slug].md\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eだけどどうもうまくいかなかったみたい。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eTypeError [ERR_INVALID_ARG_TYPE]: The \"path\" argument must be of type string. Received type undefined\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e試しに絶対パスを入れたけど、画像の変換が行われず、固定文字列が入っちゃった。\u003cbr\u003e\nプロジェクトルートから考えた相対パスを入れれば問題なく動いたけど、マークダウンファイルとの相対的な位置が合わず、プレビューもできないし嫌だな〜ということでボツ。\u003c/p\u003e\n\u003ch2 id=\"解決のためにやったこと\"\u003e解決のためにやったこと\u003c/h2\u003e\n\u003cp\u003e出ている場所は \u003ccode\u003eremarkEmbedImages\u003c/code\u003e で間違いないが、なんのこっちゃという感じ。\u003c/p\u003e\n\u003cp\u003eエラーが示していた場所はここ。\u003cbr\u003e\n\u003ca href=\"https://github.com/remarkjs/remark-embed-images/blob/main/index.js#L27\" rel=\"nofollow\"\u003ehttps://github.com/remarkjs/remark-embed-images/blob/main/index.js#L27\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e入れている \u003ccode\u003epath\u003c/code\u003e が関係あるのかと思いきや、\u003ccode\u003epath\u003c/code\u003e の引数が \u003ccode\u003eundefined\u003c/code\u003e の場合もこういうエラーが出るらしい。（※追記：エラー文に書いてあるじゃん！）\u003cbr\u003e\nVSCode で特に何もせず使えたデバッガーを利用して変数の中身を見てみると、どうやら \u003ccode\u003efile.dirname\u003c/code\u003e が原因だろうというところまでわかった。\u003c/p\u003e\n\u003cp\u003eじゃあ \u003ccode\u003efile\u003c/code\u003e はなんなの？となるけど、コードを見てもいまいち分からず・・・\u003c/p\u003e\n\u003cp\u003eなんか検索しているうちに再実装しているリポジトリを見つけた。\u003cbr\u003e\n\u003ca href=\"https://github.com/ahlec/jyosuushi/blob/0990e7c75c2df7c704acb9bcaca23bf999b3d181/scripts/markdown/parsing/embeded-images.ts\" rel=\"nofollow\"\u003ehttps://github.com/ahlec/jyosuushi/blob/0990e7c75c2df7c704acb9bcaca23bf999b3d181/scripts/markdown/parsing/embeded-images.ts\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eそんなこんなしているうちに \u003ccode\u003efile.dirname\u003c/code\u003e に \u003ccode\u003eposts\u003c/code\u003e という固定文字列を入れてみた。動いた！\u003cbr\u003e\nこの時世界が動き出した。\u003c/p\u003e\n\u003cp\u003eなんでか覚えてないけど \u003ccode\u003e.process()\u003c/code\u003e には \u003ccode\u003evfile\u003c/code\u003e を入れることができるということを知り、\u003ccode\u003evfile\u003c/code\u003e は \u003ccode\u003edirname\u003c/code\u003e や \u003ccode\u003epath\u003c/code\u003e、\u003ccode\u003ecwd\u003c/code\u003e があり、なんかみたことのあるな〜という感じ。\u003cbr\u003e\n\u003ca href=\"https://github.com/vfile/vfile\" rel=\"nofollow\"\u003ehttps://github.com/vfile/vfile\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eそうか、\u003ccode\u003eremark-embed-images\u003c/code\u003e の \u003ccode\u003efile\u003c/code\u003e は \u003ccode\u003evfile\u003c/code\u003e のことだったのか・・・となった（どうして \u003ccode\u003evfile\u003c/code\u003e なのかはまだ分かってない）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-diff\"\u003econst post = ALL_POSTS.find(post =\u003e slug \u003cspan class=\"hljs-comment\"\u003e=== post.slug) as Post\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+ const file = toVFile({ value: post.content, path: process.cwd(), dirname: 'posts' })\u003c/span\u003e\n\nconst processedContent = await unified()\n    .use(remarkParse)\n...\n    .use(rehypeStringify)\n\u003cspan class=\"hljs-deletion\"\u003e-   .process(post)\u003c/span\u003e\n\u003cspan class=\"hljs-addition\"\u003e+   .process(file)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eとしたら無事動いた 🎉\u003c/p\u003e\n\u003ch2 id=\"おわり\"\u003eおわり\u003c/h2\u003e\n\u003cp\u003eなんで動いたのかとかあんまりよく分かっていないけど、文字列を \u003ccode\u003e.process()\u003c/code\u003e に入れるとファイルの中身だけはあるけど実体は無いみたいな扱いをされて、その結果 \u003ccode\u003edirname\u003c/code\u003e が \u003ccode\u003eundefined\u003c/code\u003e になっていたとかそんな感じかなぁって思ってる。\u003cbr\u003e\nそのうち気が向いたら追ってみると思う。\u003c/p\u003e\n\u003cp\u003eとりあえず動くようになったのでよかった 😚\u003c/p\u003e","slug":"add-images-to-my-blog","title":"ブログに画像を貼れるようにした","published":"2021-10-14","publishedIndex":1,"tags":["TypeScript","Next.js","Blog"],"fileName":"add-images-to-my-blog","staticFiles":["james-harrison-vpOeXr5wmR4-unsplash.jpg"]},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"add-images-to-my-blog"},"buildId":"6lyUpe6-GWfQPga3jDf8b","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>