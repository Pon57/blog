<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><meta name="og:title" content="Rustのクロスコンパイルでハマった話 - ぽんブログ" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><title data-next-head="">Rustのクロスコンパイルでハマった話 - ぽんブログ</title><link rel="preload" href="/_next/static/css/88b30f8ffe8ac8ea.css" as="style"/><link rel="preload" href="/_next/static/css/481549497a7fc96d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/88b30f8ffe8ac8ea.css" data-n-g=""/><link rel="stylesheet" href="/_next/static/css/481549497a7fc96d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-8cac0b4b405cede1.js" defer=""></script><script src="/_next/static/chunks/framework-2f335d22a7318891.js" defer=""></script><script src="/_next/static/chunks/main-9794c8d136154d2b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-aaf6b887cfc00048.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-358404b86ac864dc.js" defer=""></script><script src="/_next/static/aNY9VFc6XQxNBHvZEDfUT/_buildManifest.js" defer=""></script><script src="/_next/static/aNY9VFc6XQxNBHvZEDfUT/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="_app_site__wQ_HZ"><header class="_app_heading__uRQQR"><a class="_app_brand__aiSQf" href="/">ぽんブログ</a></header><div class="_app_content__mHXSR"><div class="_slug__published___nJg1">2024-03-21</div><h1 class="_slug__title__xQmM2">Rustのクロスコンパイルでハマった話</h1><p class="_slug__tags__ZhcyH"><span class="_slug__tag__hrYB6">Rust</span></p><div class="_slug__content__C7UY7"><p><a href="/posts/smashfreaks-replace-with-rust">WebサービスをRustでフルリプレイスした話</a> を書きましたが、途中で ECS Task の cpu_architecture を X86_64 から ARM に変更しています。（なんか Graviton2 がちょっと安いしちょっと性能がいいらしい）<br>
その際に GitHub Actions 上でクロスコンパイルをする必要があったのですが、それでハマったのでメモしておきます。<br>
ちなみにこれが本当に正しいのかよくわかってないので、別の良い方法があるかもしれません。</p>
<h2 id="前提">前提</h2>
<ul>
<li>この Rust プロジェクトは axum で作られた Web アプリケーションです。</li>
<li>GitHub Actions 上でビルドされ、AWS ECS にデプロイされます。</li>
<li>GitHub Actions では ubuntu-latest を使っていて、これは現状 x86_64 です。（<a href="https://github.blog/changelog/2023-10-30-accelerate-your-ci-cd-with-arm-based-hosted-runners-in-github-actions/" rel="nofollow">Accelerate your CI/CD with Arm-based hosted runners in GitHub Actions - The GitHub Blog</a> によるともうすぐ使えるようになるかもしれない）</li>
<li>実行コンテナイメージは <code>gcr.io/distroless/cc-debian12</code> です。</li>
</ul>
<h2 id="まず何をやったか">まず何をやったか</h2>
<p>一番楽な方法をまず試します。<br>
<code>docker/build-push-action</code> を使って Docker イメージをビルドしているので、これに <code>platforms: linux/arm64</code> を追加してみました。すると・・・？</p>
<p><img src="./static/cross-compile-before.png" alt="Before"></p>
<p>脅威の Billable time <strong>5h 10m</strong>！</p>
<h2 id="何が問題だったか">何が問題だったか</h2>
<p>Docker のビルドで実行ホストと違うプラットフォーム用のコンテナのビルドには QEMU エミュレーションが使われるらしいのですが、これがどうも遅いらしいです。</p>
<h2 id="どう解決したか">どう解決したか</h2>
<p>Rust のクロスコンパイルを使うことにしました。しかし調べてすぐ出てくるような方法ではイマイチうまく解決できませんでした。最終的には色々なところからちょっとずつ拾ってきて試したところ動くようになりました。</p>
<pre><code class="hljs language-shell">apt-get install g++-aarch64-linux-gnu
CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER="aarch64-linux-gnu-gcc"
CC_aarch64_unknown_linux_gnu="aarch64-linux-gnu-gcc"
CXX_aarch64_unknown_linux_gnu="aarch64-linux-gnu-g++"
</code></pre>
<blockquote>
<p><a href="https://kerkour.com/rust-cross-compilation" rel="nofollow">https://kerkour.com/rust-cross-compilation</a></p>
</blockquote>
<pre><code class="hljs language-shell">dpkg --add-architecture arm64
apt-get install libssl-dev:arm64
</code></pre>
<blockquote>
<p><a href="https://fltk-rs.github.io/fltk-book/Cross-Compiling.html#x64-linux-gnu-to-aarch64-linux-gnu" rel="nofollow">https://fltk-rs.github.io/fltk-book/Cross-Compiling.html#x64-linux-gnu-to-aarch64-linux-gnu</a></p>
</blockquote>
<pre><code class="hljs language-shell">PKG_CONFIG_SYSROOT_DIR="/usr/aarch64-linux-gnu/"
</code></pre>
<blockquote>
<p><a href="https://stackoverflow.com/questions/68871193/pkg-config-error-during-rust-cross-compilation" rel="nofollow">https://stackoverflow.com/questions/68871193/pkg-config-error-during-rust-cross-compilation</a></p>
</blockquote>
<p>これらを Dockerfile に追加してビルドしました。すると・・・？</p>
<p><img src="./static/cross-compile-after.png" alt="After"></p>
<p>Billable time <strong>22m</strong>！</p>
<h2 id="結果">結果</h2>
<p>嬉しい（なんか変なところとかこうした方がいいみたいなのがあったらよければ教えてください）</p></div><div class="_slug__footer__HMsFO">※サイト内の商品リンクは一部アフィリエイトリンクとなっています。</div></div><footer class="_app_footer___uvS6"><div class="_app_link__Y_6XC"><a href="/privacy-policy">プライバシーポリシー</a><a href="/disclaimer">免責事項</a></div><div>© 2021<!-- --> <a target="_blank" href="https://twitter.com/pon_dev">Pon</a></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"content":"\u003cp\u003e\u003ca href=\"/posts/smashfreaks-replace-with-rust\"\u003eWebサービスをRustでフルリプレイスした話\u003c/a\u003e を書きましたが、途中で ECS Task の cpu_architecture を X86_64 から ARM に変更しています。（なんか Graviton2 がちょっと安いしちょっと性能がいいらしい）\u003cbr\u003e\nその際に GitHub Actions 上でクロスコンパイルをする必要があったのですが、それでハマったのでメモしておきます。\u003cbr\u003e\nちなみにこれが本当に正しいのかよくわかってないので、別の良い方法があるかもしれません。\u003c/p\u003e\n\u003ch2 id=\"前提\"\u003e前提\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eこの Rust プロジェクトは axum で作られた Web アプリケーションです。\u003c/li\u003e\n\u003cli\u003eGitHub Actions 上でビルドされ、AWS ECS にデプロイされます。\u003c/li\u003e\n\u003cli\u003eGitHub Actions では ubuntu-latest を使っていて、これは現状 x86_64 です。（\u003ca href=\"https://github.blog/changelog/2023-10-30-accelerate-your-ci-cd-with-arm-based-hosted-runners-in-github-actions/\" rel=\"nofollow\"\u003eAccelerate your CI/CD with Arm-based hosted runners in GitHub Actions - The GitHub Blog\u003c/a\u003e によるともうすぐ使えるようになるかもしれない）\u003c/li\u003e\n\u003cli\u003e実行コンテナイメージは \u003ccode\u003egcr.io/distroless/cc-debian12\u003c/code\u003e です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"まず何をやったか\"\u003eまず何をやったか\u003c/h2\u003e\n\u003cp\u003e一番楽な方法をまず試します。\u003cbr\u003e\n\u003ccode\u003edocker/build-push-action\u003c/code\u003e を使って Docker イメージをビルドしているので、これに \u003ccode\u003eplatforms: linux/arm64\u003c/code\u003e を追加してみました。すると・・・？\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"./static/cross-compile-before.png\" alt=\"Before\"\u003e\u003c/p\u003e\n\u003cp\u003e脅威の Billable time \u003cstrong\u003e5h 10m\u003c/strong\u003e！\u003c/p\u003e\n\u003ch2 id=\"何が問題だったか\"\u003e何が問題だったか\u003c/h2\u003e\n\u003cp\u003eDocker のビルドで実行ホストと違うプラットフォーム用のコンテナのビルドには QEMU エミュレーションが使われるらしいのですが、これがどうも遅いらしいです。\u003c/p\u003e\n\u003ch2 id=\"どう解決したか\"\u003eどう解決したか\u003c/h2\u003e\n\u003cp\u003eRust のクロスコンパイルを使うことにしました。しかし調べてすぐ出てくるような方法ではイマイチうまく解決できませんでした。最終的には色々なところからちょっとずつ拾ってきて試したところ動くようになりました。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003eapt-get install g++-aarch64-linux-gnu\nCARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=\"aarch64-linux-gnu-gcc\"\nCC_aarch64_unknown_linux_gnu=\"aarch64-linux-gnu-gcc\"\nCXX_aarch64_unknown_linux_gnu=\"aarch64-linux-gnu-g++\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://kerkour.com/rust-cross-compilation\" rel=\"nofollow\"\u003ehttps://kerkour.com/rust-cross-compilation\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003edpkg --add-architecture arm64\napt-get install libssl-dev:arm64\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://fltk-rs.github.io/fltk-book/Cross-Compiling.html#x64-linux-gnu-to-aarch64-linux-gnu\" rel=\"nofollow\"\u003ehttps://fltk-rs.github.io/fltk-book/Cross-Compiling.html#x64-linux-gnu-to-aarch64-linux-gnu\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003ePKG_CONFIG_SYSROOT_DIR=\"/usr/aarch64-linux-gnu/\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/68871193/pkg-config-error-during-rust-cross-compilation\" rel=\"nofollow\"\u003ehttps://stackoverflow.com/questions/68871193/pkg-config-error-during-rust-cross-compilation\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eこれらを Dockerfile に追加してビルドしました。すると・・・？\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"./static/cross-compile-after.png\" alt=\"After\"\u003e\u003c/p\u003e\n\u003cp\u003eBillable time \u003cstrong\u003e22m\u003c/strong\u003e！\u003c/p\u003e\n\u003ch2 id=\"結果\"\u003e結果\u003c/h2\u003e\n\u003cp\u003e嬉しい（なんか変なところとかこうした方がいいみたいなのがあったらよければ教えてください）\u003c/p\u003e","slug":"rust-cross-compile","title":"Rustのクロスコンパイルでハマった話","published":"2024-03-21","publishedIndex":0,"tags":["Rust"],"fileName":"rust-cross-compile","staticFiles":["cross-compile-after.png","cross-compile-before.png"]},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"rust-cross-compile"},"buildId":"aNY9VFc6XQxNBHvZEDfUT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>