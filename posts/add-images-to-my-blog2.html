<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="og:title" content="ブログに画像を貼れるようにした〜その後〜 - ぽんブログ"/><meta property="og:type" content="article"/><title>ブログに画像を貼れるようにした〜その後〜 - ぽんブログ</title><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/179f71b27607d118.css" as="style"/><link rel="stylesheet" href="/_next/static/css/179f71b27607d118.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ec6babc9d8f6a638.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ec6babc9d8f6a638.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-7ee66019f7f6d30f.js" defer=""></script><script src="/_next/static/chunks/framework-0c60727b75b88c05.js" defer=""></script><script src="/_next/static/chunks/main-1db319fd0477f1d3.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9409279b55695688.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-48a2737cba2145e4.js" defer=""></script><script src="/_next/static/5bqqAzBXod-sQstGkffqx/_buildManifest.js" defer=""></script><script src="/_next/static/5bqqAzBXod-sQstGkffqx/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="_app_site__jPXzT"><header class="_app_heading__u1cWZ"><a class="_app_brand__F_5Hf" href="/">ぽんブログ</a></header><div class="_app_content__ey6bu"><div class="_slug__published__LGCb2">2022-01-26</div><h1 class="_slug__title__U2nRG">ブログに画像を貼れるようにした〜その後〜</h1><p class="_slug__tags__6dAX_"><span class="_slug__tag__8ag_u">TypeScript</span><span class="_slug__tag__8ag_u">Next.js</span><span class="_slug__tag__8ag_u">Blog</span></p><div class="_slug__content__nxJ4V"><p><a href="/posts/add-images-to-my-blog">ブログに画像を貼れるようにした</a> でブログに画像を貼れるようにしたけど、base64 で埋め込んでいたため少し問題があった。<br>
それを修正したのでこれも書いておく。</p>
<h2 id="何が問題だったのか">何が問題だったのか</h2>
<p>base64 で埋め込んでいるため、テキストデータの量が画像によって多くなってしまう。<br>
何が問題かと言うと、テキストデータを静的に HTML に入れているので、HTML ファイルの容量が大きくなってしまい、結果ページ読み込みの時間がかかるようになってしまっていた。<br>
画像ファイルであれば非同期に読み込まれるっぽく、レンダリングをブロックすることがないっぽい。(正確には未指定で decoding=auto らしいから大体の最新ブラウザでは非同期で読み込まれる感じかな？ <a href="https://developer.mozilla.org/ja/docs/Web/HTML/Element/img#attr-decoding" target="_blank" rel="nofollow noopener noreferrer">&#x3C;img>: 画像埋め込み要素 - HTML: HyperText Markup Language | MDN</a>)</p>
<p>また、<code>yarn dev</code> でページを表示する度に容量大きすぎまっせ的な警告が出てしまう。（まあこれは鬱陶しいだけなので良し）</p>
<p>じゃあ <code>/public</code> 配下に画像ファイル置いて普通に読み込めばいいじゃん？と思うが、書いてる最中（VSCode 上）や GitHub でプレビューして欲しかった。特に意味はないけどこだわりみたいなもの。<br>
index.md から画像への相対的な位置が違うので、どっちか（ビルド後の HTML と index.md）をうまくいかせようとするとどっちかが参照できないのであった。</p>
<h2 id="どう直したか">どう直したか</h2>
<p><a href="https://github.com/Pon57/blog/issues/8" target="_blank" rel="nofollow noopener noreferrer">画像を base64 で埋め込むやつじゃない感じにできないか考える · Issue #8 · Pon57/blog</a></p>
<p>まず <a href="https://github.com/remarkjs/remark-embed-images" target="_blank" rel="nofollow noopener noreferrer">remarkjs/remark-embed-images</a> から <a href="https://github.com/remarkjs/remark-images" target="_blank" rel="nofollow noopener noreferrer">remarkjs/remark-images</a> に変えた。</p>
<p>そして <a href="https://nextjs.org/docs/advanced-features/static-html-export" target="_blank" rel="nofollow noopener noreferrer">Static HTML Export</a> 時に <code>/posts/blog/[slug]/static</code> フォルダにあるファイルを全て <code>/public/static</code> にコピーするようにした。<br>
つまり <code>/public/static/hoge.jpg</code> みたいなファイルが生える。<br>
同名のファイルがあった場合は後に同じ処理が走った時点で新しいファイルで上書きされそうな気がするけど、そこはまあ運用でカバーする。</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">copyStaticFiles</span> = (<span class="hljs-params">slug: <span class="hljs-built_in">string</span>, staticFiles: <span class="hljs-built_in">string</span>[]</span>) => {
    staticFiles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">staticFile</span> =></span> {
        fs.<span class="hljs-title function_">mkdirSync</span>(path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'public/posts/static'</span>), { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> })
        fs.<span class="hljs-title function_">copyFileSync</span>(
            path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'posts/blog'</span>, slug, <span class="hljs-string">'static'</span>, staticFile),
            path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'public/posts/static'</span>, staticFile),
        )
    })
}
</code></pre>
<p>こんな感じの関数を作って、これを <code>getStaticProps</code> の中で呼ぶようにした。<br>
<code>staticFiles</code> は <code>/posts/[slug]/index.md</code> からブログのデータを取ってくるときに一緒に <code>/posts/[slug]/static</code> ディレクトリの中を見てファイル名を持ってきてる。<br>
かなりのゴリ押し。もっといい書き方も普通にありそうだけど、一旦動けばいいでこんな感じにしちゃった。<br>
とりあえず動いたので :yoshi:</p>
<p><code>/posts/[slug]/index.md</code> からみた <code>static/hoge.jpg</code> は生成される HTML からみた <code>static/hoge.jpg</code> と同じなので、<code>index.md</code> 上のプレビューでも表示されるし、出力された HTML でも表示できる。<br>
変更してみたら確かに読み込みが早くなった気がする。</p>
<p>ファイルを <code>/public</code> 配下に書き込んじゃえばいいんじゃんというのはこのブログを見ていて思った。なんでかそれまでは思いつかなかった。<br>
<a href="https://so99ynoodles.com/blog/nextjs-create-og-image-automatically" target="_blank" rel="nofollow noopener noreferrer">Next.js で OpenGraph 画像を自動生成する | so99ynoodles</a></p></div></div><footer class="_app_footer__clEfD">© 2021<!-- --> <a target="_blank" rel="noreferrer" href="https://twitter.com/pon_dev">Pon</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"content":"\u003cp\u003e\u003ca href=\"/posts/add-images-to-my-blog\"\u003eブログに画像を貼れるようにした\u003c/a\u003e でブログに画像を貼れるようにしたけど、base64 で埋め込んでいたため少し問題があった。\u003cbr\u003e\nそれを修正したのでこれも書いておく。\u003c/p\u003e\n\u003ch2 id=\"何が問題だったのか\"\u003e何が問題だったのか\u003c/h2\u003e\n\u003cp\u003ebase64 で埋め込んでいるため、テキストデータの量が画像によって多くなってしまう。\u003cbr\u003e\n何が問題かと言うと、テキストデータを静的に HTML に入れているので、HTML ファイルの容量が大きくなってしまい、結果ページ読み込みの時間がかかるようになってしまっていた。\u003cbr\u003e\n画像ファイルであれば非同期に読み込まれるっぽく、レンダリングをブロックすることがないっぽい。(正確には未指定で decoding=auto らしいから大体の最新ブラウザでは非同期で読み込まれる感じかな？ \u003ca href=\"https://developer.mozilla.org/ja/docs/Web/HTML/Element/img#attr-decoding\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e\u0026#x3C;img\u003e: 画像埋め込み要素 - HTML: HyperText Markup Language | MDN\u003c/a\u003e)\u003c/p\u003e\n\u003cp\u003eまた、\u003ccode\u003eyarn dev\u003c/code\u003e でページを表示する度に容量大きすぎまっせ的な警告が出てしまう。（まあこれは鬱陶しいだけなので良し）\u003c/p\u003e\n\u003cp\u003eじゃあ \u003ccode\u003e/public\u003c/code\u003e 配下に画像ファイル置いて普通に読み込めばいいじゃん？と思うが、書いてる最中（VSCode 上）や GitHub でプレビューして欲しかった。特に意味はないけどこだわりみたいなもの。\u003cbr\u003e\nindex.md から画像への相対的な位置が違うので、どっちか（ビルド後の HTML と index.md）をうまくいかせようとするとどっちかが参照できないのであった。\u003c/p\u003e\n\u003ch2 id=\"どう直したか\"\u003eどう直したか\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/Pon57/blog/issues/8\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003e画像を base64 で埋め込むやつじゃない感じにできないか考える · Issue #8 · Pon57/blog\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eまず \u003ca href=\"https://github.com/remarkjs/remark-embed-images\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eremarkjs/remark-embed-images\u003c/a\u003e から \u003ca href=\"https://github.com/remarkjs/remark-images\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eremarkjs/remark-images\u003c/a\u003e に変えた。\u003c/p\u003e\n\u003cp\u003eそして \u003ca href=\"https://nextjs.org/docs/advanced-features/static-html-export\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eStatic HTML Export\u003c/a\u003e 時に \u003ccode\u003e/posts/blog/[slug]/static\u003c/code\u003e フォルダにあるファイルを全て \u003ccode\u003e/public/static\u003c/code\u003e にコピーするようにした。\u003cbr\u003e\nつまり \u003ccode\u003e/public/static/hoge.jpg\u003c/code\u003e みたいなファイルが生える。\u003cbr\u003e\n同名のファイルがあった場合は後に同じ処理が走った時点で新しいファイルで上書きされそうな気がするけど、そこはまあ運用でカバーする。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecopyStaticFiles\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003eslug: \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e, staticFiles: \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e[]\u003c/span\u003e) =\u003e {\n    staticFiles.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003estaticFile\u003c/span\u003e =\u003e\u003c/span\u003e {\n        fs.\u003cspan class=\"hljs-title function_\"\u003emkdirSync\u003c/span\u003e(path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(process.\u003cspan class=\"hljs-title function_\"\u003ecwd\u003c/span\u003e(), \u003cspan class=\"hljs-string\"\u003e'public/posts/static'\u003c/span\u003e), { \u003cspan class=\"hljs-attr\"\u003erecursive\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e })\n        fs.\u003cspan class=\"hljs-title function_\"\u003ecopyFileSync\u003c/span\u003e(\n            path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(process.\u003cspan class=\"hljs-title function_\"\u003ecwd\u003c/span\u003e(), \u003cspan class=\"hljs-string\"\u003e'posts/blog'\u003c/span\u003e, slug, \u003cspan class=\"hljs-string\"\u003e'static'\u003c/span\u003e, staticFile),\n            path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(process.\u003cspan class=\"hljs-title function_\"\u003ecwd\u003c/span\u003e(), \u003cspan class=\"hljs-string\"\u003e'public/posts/static'\u003c/span\u003e, staticFile),\n        )\n    })\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eこんな感じの関数を作って、これを \u003ccode\u003egetStaticProps\u003c/code\u003e の中で呼ぶようにした。\u003cbr\u003e\n\u003ccode\u003estaticFiles\u003c/code\u003e は \u003ccode\u003e/posts/[slug]/index.md\u003c/code\u003e からブログのデータを取ってくるときに一緒に \u003ccode\u003e/posts/[slug]/static\u003c/code\u003e ディレクトリの中を見てファイル名を持ってきてる。\u003cbr\u003e\nかなりのゴリ押し。もっといい書き方も普通にありそうだけど、一旦動けばいいでこんな感じにしちゃった。\u003cbr\u003e\nとりあえず動いたので :yoshi:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/posts/[slug]/index.md\u003c/code\u003e からみた \u003ccode\u003estatic/hoge.jpg\u003c/code\u003e は生成される HTML からみた \u003ccode\u003estatic/hoge.jpg\u003c/code\u003e と同じなので、\u003ccode\u003eindex.md\u003c/code\u003e 上のプレビューでも表示されるし、出力された HTML でも表示できる。\u003cbr\u003e\n変更してみたら確かに読み込みが早くなった気がする。\u003c/p\u003e\n\u003cp\u003eファイルを \u003ccode\u003e/public\u003c/code\u003e 配下に書き込んじゃえばいいんじゃんというのはこのブログを見ていて思った。なんでかそれまでは思いつかなかった。\u003cbr\u003e\n\u003ca href=\"https://so99ynoodles.com/blog/nextjs-create-og-image-automatically\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003eNext.js で OpenGraph 画像を自動生成する | so99ynoodles\u003c/a\u003e\u003c/p\u003e","slug":"add-images-to-my-blog2","title":"ブログに画像を貼れるようにした〜その後〜","published":"2022-01-26","publishedIndex":0,"tags":["TypeScript","Next.js","Blog"],"fileName":"add-images-to-my-blog2","staticFiles":[]},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"add-images-to-my-blog2"},"buildId":"5bqqAzBXod-sQstGkffqx","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>